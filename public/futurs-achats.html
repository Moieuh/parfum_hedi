<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Futurs achats - Parfums</title>
  <script defer src="script.js"></script> <!-- on garde, pour le style global si besoin -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <a href="index.html" class="logo" title="Accueil">
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
        <circle cx="16" cy="16" r="15" stroke="#6366f1" stroke-width="2" fill="#fff"/>
        <path d="M16 10v8M16 18l-4 4M16 18l4 4" stroke="#00ff75" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </a>
    <nav>
      <ul>
        <li><a href="index.html">Classement</a></li>
        <li><a href="collection.html">Collection</a></li>
        <li><a href="futurs-achats.html">Futurs achats</a></li>
      </ul>
    </nav>
    <a href="Login.html" id="user-name" class="user-name"></a>
  </header>
  <main>
    <h1>Futurs achats de parfums</h1>
    <div class="search-filter-container">
      <input type="text" id="search-input" placeholder="üîç Rechercher un parfum..." />
    </div>
    <!-- SECTION SLIDER DES PREFERES -->
    <div id="section-slider-pref" style="margin-bottom:32px;">
      <h2 style="color:#432818; text-align:center;">‚≠ê Futurs achats  ‚≠ê</h2>
      <div id="slider-pref" class="slider"></div>
    </div>
    <!-- FORMULAIRE ET LISTE CLASSIQUE -->
    <form id="ajout-futur-achat" style="margin-bottom:18px;">
      <input type="text" id="futur-nom" placeholder="Nom du parfum" required />
      <input type="text" id="futur-marque" placeholder="Marque" />
      <input type="number" id="futur-prix" placeholder="Prix estim√© (‚Ç¨)" min="0" step="0.01"/>
      <button type="submit">Ajouter √† la liste</button>
    </form>
    <ul id="liste-futurs-achats"></ul>
  </main>
   <footer>
    <p>&copy; 2025 Parf. Tous droits r√©serv√©s.</p>
    <p>By Ali Belhassen directed by un casse couille </p>
  </footer>
  <script>
  const MAX_PRIO = 4; // Limite de priorit√©s

  window.onPrioImageSelected = async function(nom, input) {
    if (input.files && input.files[0]) {
      const formData = new FormData();
      formData.append('image', input.files[0]);
      formData.append('utilisateur', localStorage.getItem('utilisateur') || '');

      try {
        const res = await fetch(`/api/futurs-achats/${encodeURIComponent(nom)}/image`, {
          method: 'POST',
          body: formData
        });
        if (!res.ok) throw new Error((await res.json()).error || 'Erreur upload image');
        await afficherSliderPrio();
      } catch (err) {
        alert(err.message || 'Erreur lors de l‚Äôupload');
      }
    }
  };

  // --- API Fetch CRUD c√¥t√© serveur ---
  async function fetchFutursAchats() {
    const res = await fetch('/api/futurs-achats');
    return await res.json();
  }
  async function ajouterFuturAchat(nom, marque, prix, prioritaire) {
    const user = localStorage.getItem('utilisateur') || '';
    const res = await fetch('/api/futurs-achats', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-user': user },
      body: JSON.stringify({ nom, marque, prix, prioritaire, utilisateur: user })
    });
    if (!res.ok) throw new Error((await res.json()).error || "Erreur ajout");
    return res.json();
  }
  async function supprimerFuturAchatAPI(nom) {
    const user = localStorage.getItem('utilisateur') || '';
    const res = await fetch(`/api/futurs-achats/${encodeURIComponent(nom)}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json', 'x-user': user },
      body: JSON.stringify({ utilisateur: user })
    });
    if (!res.ok) throw new Error((await res.json()).error || "Erreur suppression");
    return res.json();
  }
  async function updateFuturAchat(nom, dataUpdate) {
    const user = localStorage.getItem('utilisateur') || '';
    const res = await fetch(`/api/futurs-achats/${encodeURIComponent(nom)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'x-user': user },
      body: JSON.stringify({ ...dataUpdate, utilisateur: user })
    });
    if (!res.ok) throw new Error((await res.json()).error || "Erreur maj");
    return res.json();
  }

  // --- Slider des priorit√©s ---
  async function afficherSliderPrio() {
    const liste = await fetchFutursAchats();
    const prios = liste.filter(item => item.prioritaire).slice(0, MAX_PRIO);
    const slider = document.getElementById('slider-pref');
    if (!prios.length) {
      slider.innerHTML = '<div style="color:#a5b4fc;text-align:center;padding:18px;">S√©lectionnez vos priorit√©s ‚≠ê</div>';
      return;
    }
    slider.innerHTML = `<div class="slider-list"></div>`;
    const sliderList = slider.querySelector('.slider-list');
    prios.forEach((item, idx) => {
      const image = item.image ? `/${item.image}` : 'https://cdn-icons-png.flaticon.com/512/748/748111.png';
      const delayAuto = (idx * 2.5) + 's';
      const delayShow = (idx * 2.5) + 's';
      sliderList.innerHTML += `
        <div class="slider-item" style="--delayShow:${delayShow}; --delayAuto:${delayAuto};">
          <div class="card">
            <img src="${image}" class="slider-img" alt="Parfum prioritaire">
            <div style="margin-bottom:8px;">
              <span class="pref-star">‚≠ê</span>
              <b>${item.nom}</b>
            </div>
            <div>${item.marque ? '('+item.marque+')' : ''}</div>
            <div>${item.prix ? 'üí∏ '+item.prix+' ‚Ç¨' : ''}</div>
            <button class="btn-img" onclick="document.getElementById('img-input-${idx}').click()">Changer l'image</button>
            <input type="file" id="img-input-${idx}" accept="image/*" style="display:none;" onchange="onPrioImageSelected('${item.nom.replace(/'/g,"\\'")}', this)">
          </div>
        </div>
      `;
    });
  }

  // --- Affichage principal ---
  async function afficherFutursAchats() {
    const liste = await fetchFutursAchats();
    afficherSliderPrio();

    const user = localStorage.getItem('utilisateur') || '';
    const isHedi = user === 'hedi';

    const nbPrio = liste.filter(item => item.prioritaire).length;
    const ul = document.getElementById('liste-futurs-achats');
    ul.className = 'futur-card-list';
    ul.innerHTML = '';
    liste.forEach((item, idx) => {
      const isPrio = !!item.prioritaire;
      const image = item.image ? `/${item.image}` : '';
      const disabled = (!isPrio && nbPrio >= MAX_PRIO) || !isHedi ? 'disabled' : '';
      const titleTxt = !isHedi
        ? 'Action r√©serv√©e √† hedi'
        : (isPrio ? 'Retirer des priorit√©s' : (nbPrio >= MAX_PRIO ? 'Vous ne pouvez avoir que 4 priorit√©s' : 'Ajouter aux priorit√©s'));

      const li = document.createElement('li');
      li.className = 'futur-card';
      li.innerHTML = `
        <div class="heart-container" title="${titleTxt}">
          <input type="checkbox" class="checkbox" id="heart-${idx}" ${isPrio ? 'checked' : ''} ${disabled}
            onchange="togglePrio('${item.nom.replace(/'/g,"\\'")}', this.checked)">
          <div class="svg-container">
            <svg viewBox="0 0 24 24" class="svg-outline" xmlns="http://www.w3.org/2000/svg">
              <path d="M17.5,1.917a6.4,6.4,0,0,0-5.5,3.3,6.4,6.4,0,0,0-5.5-3.3A6.8,6.8,0,0,0,0,8.967c0,4.547,4.786,9.513,8.8,12.88a4.974,4.974,0,0,0,6.4,0C19.214,18.48,24,13.514,24,8.967A6.8,6.8,0,0,0,17.5,1.917Z"></path>
            </svg>
            <svg viewBox="0 0 24 24" class="svg-filled" xmlns="http://www.w3.org/2000/svg">
              <path d="M17.5,1.917a6.4,6.4,0,0,0-5.5,3.3,6.4,6.4,0,0,0-5.5-3.3A6.8,6.8,0,0,0,0,8.967c0,4.547,4.786,9.513,8.8,12.88a4.974,4.974,0,0,0,6.4,0C19.214,18.48,24,13.514,24,8.967A6.8,6.8,0,0,0,17.5,1.917Z"></path>
            </svg>
            <svg class="svg-celebrate" width="100" height="100" xmlns="http://www.w3.org/2000/svg">
              <polygon points="10,10 20,20"></polygon>
              <polygon points="10,50 20,50"></polygon>
              <polygon points="20,80 30,70"></polygon>
              <polygon points="90,10 80,20"></polygon>
              <polygon points="90,50 80,50"></polygon>
              <polygon points="80,80 70,70"></polygon>
            </svg>
          </div>
        </div>

        <strong>${item.nom}</strong>
        ${item.marque ? `<div>(${item.marque})</div>` : ''}
        ${item.prix ? `<div style="margin-top:6px;">üí∏ ${item.prix} ‚Ç¨</div>` : ''}
        <button class="futur-card-delete" title="${isHedi ? 'Supprimer' : 'R√©serv√© √† hedi'}" ${!isHedi ? 'disabled' : ''} onclick="${isHedi ? `supprimerFuturAchat('${item.nom.replace(/'/g,"\\'")}')` : 'void(0)'}">‚ùå</button>
      `;
      ul.appendChild(li);
    });
  }

  // --- Actions bouton ---
  window.supprimerFuturAchat = async function(nom) {
    try {
      await supprimerFuturAchatAPI(nom);
      afficherFutursAchats();
    } catch (err) {
      alert(err.message || 'Erreur lors de la suppression');
    }
  }
  window.togglePrio = async function(nom, toPrio) {
    try {
      await updateFuturAchat(nom, { prioritaire: !!toPrio });
      afficherFutursAchats();
    } catch (err) {
      alert(err.message || 'Erreur maj priorit√©');
    }
  }

  // --- Recherche temps r√©el ---
  document.getElementById('search-input').addEventListener('input', async function() {
    const terme = this.value.trim().toLowerCase();
    const liste = await fetchFutursAchats();
    if (!terme) { afficherFutursAchats(); return; }
    const filtres = liste.filter(item =>
      item.nom.toLowerCase().includes(terme) ||
      (item.marque && item.marque.toLowerCase().includes(terme)) ||
      (item.prix && item.prix.toString().includes(terme))
    );
    // R√©affichage filtr√©
    const ul = document.getElementById('liste-futurs-achats');
    ul.innerHTML = '';
    filtres.forEach((item, idx) => {
      const image = item.image ? `/${item.image}` : '';
      ul.innerHTML += `<li>${item.nom}</li>`; // tu peux reprendre le rendu complet si besoin
    });
  });

  // --- S√©curit√© formulaire ---
  document.addEventListener('DOMContentLoaded', function() {
    const user = localStorage.getItem('utilisateur') || '';
    document.getElementById('user-name').textContent = user;
    afficherFutursAchats();

    if (user !== 'hedi') {
      document.getElementById('ajout-futur-achat').style.display = 'none';
    }
  });

  // --- Ajout futur achat ---
  document.getElementById('ajout-futur-achat').onsubmit = async function(e) {
    e.preventDefault();
    const user = localStorage.getItem('utilisateur') || '';
    if (user !== 'hedi') {
      alert('Seul hedi peut ajouter un futur achat.');
      return false;
    }
    const nom = document.getElementById('futur-nom').value.trim();
    const marque = document.getElementById('futur-marque').value.trim();
    const prix = document.getElementById('futur-prix').value.trim();
    if (!nom) return;
    try {
      await ajouterFuturAchat(nom, marque, prix, false);
      afficherFutursAchats();
      this.reset();
    } catch (err) {
      alert(err.message);
    }
  };
</script>
